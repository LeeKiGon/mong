<!doctype html>
<html lang="ko">
    <head>
        <!-- Webpage Title -->
        <title>MONG</title>

        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bulma CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">

        <!-- JS -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

        <script>
            // ID, PW, nickname을 받아서 DB에 저장
            function register() {
                let userid = $('#user-id').val()
                let userpw = $('#user-pw').val()
                let userpw2 = $('#user-pw2').val()
                let usernick = $('#user-nick').val()

                // 유저가 정규표현식에 맞지 않는 아이디를 사용했거나, 중복확인을 하지 않았을때
                // 클래스 여부로 판단해서 체크
                if ($('#help-id').hasClass('is-danger')) {
                    alert("아이디를 다시 확인해주세요.")
                    return;
                } else if (!$('#help-id').hasClass("is-safe")) {
                    alert("아이디 중복확인을 해주세요.")
                    return;
                }

                // 유저의 패스워드, 닉네임이 정규표현식에 맞는지
                // 또는 입력여부 판단 및 비밀번호 확인칸에 적은 값과 비밀번호 칸에 적은 값이 일치하는지 확인
                // 닉네임도 마찬가지 과정을 진행함
                // id와 마찬가지로 확인메세지 id태그가 class를 포함하는지 여부로 체크
                // 필요없는 class를 삭제해서 확인메세지를 명확하게 출력
                if (userpw == "") {
                    $('#help-pw').text("비밀번호를 입력해주세요.").removeClass("explanation-text").addClass("is-danger")
                    $('#user-pw').focus()
                    return;
                } else if (!is_password(userpw)) {
                    $('#help-pw').text("비밀번호의 형식을 확인해주세요. 8~20자리의 알파벳 소문자와 숫자, 특수문자(!@#$%^&*)의 조합이어야 합니다.").removeClass("explanation-text").removeClass("is-safe").addClass("is-danger")
                    $('#user-pw').focus()
                    return;
                } else {
                    $('#help-pw').text("사용 가능한 비밀번호입니다.").removeClass("is-danger").addClass("is-safe")
                }
                if (userpw2 == "") {
                    $('#help-pw2').text("비밀번호를 다시 입력해주세요.").removeClass("explanation-text").addClass("is-danger")
                    $('#user-pw2').focus()
                    return;
                } else if (userpw != userpw2) {
                    $('#help-pw2').text("비밀번호가 일치하지 않습니다.").removeClass("explanation-text").addClass("is-danger")
                    $('#user-pw2').focus()
                    return;
                } else {
                    $('#help-pw2').text("비밀번호가 일치합니다.").removeClass("is-danger").addClass("is-safe")
                }
                if ($('#help-nick').hasClass('is-danger')) {
                    alert("닉네임을 다시 확인해주세요.")
                    return;
                } else if (!$('#help-nick').hasClass("is-safe")) {
                    alert("닉네임 중복확인을 해주세요.")
                    return;
                }


                // 모든 과정이 문제가 없으면 서버에 유저가 적은 값을 보내서
                // mongoDB에 저장함.
                $.ajax({
                    type: "POST",
                    url: "/api/register",
                    data: {
                        id_give: userid,
                        pw_give: userpw,
                        nickname_give: usernick
                    },
                    success: function (response) {
                        if (response['result'] == 'success') {
                            alert('회원가입이 완료되었습니다!')
                            window.location.href = '/'
                        } else {
                            alert(response['msg'])
                        }
                    }
                })
            }

            // 유저 id 정규표현식 판단 함수
            function is_id(asValue) {
                let regExp = /^(?=.*[a-zA-Z])[a-zA-Z0-9]{6,20}$/;
                return regExp.test(asValue);
            }

            // 유저 닉네임 정규표현식 판단 함수
            function is_nickname(asValue) {
                let regExp = /^(?=.*[가-힣])[가-힣]{2,8}$/;
                return regExp.test(asValue);
            }

            // 유저 비밀번호 정규표현식 판단 함수
            function is_password(asValue) {
                let regExp = /^(?=.*\d)(?=.*[a-zA-Z])[0-9a-zA-Z!@#$%^&*]{8,20}$/;
                return regExp.test(asValue);
            }

            // ID 중복확인 함수
            // '중복확인' 버튼에 onclick 함수로 기능함.
            function check_id() {
                let userid = $("#user-id").val()
                console.log(userid)
                if (userid == "") {
                    // 유저가 id를 적지 않았으면
                    $("#help-id").text("아이디를 입력해주세요.").addClass("is-danger")
                    // 입력 칸 강조 효과
                    $("#user-id").focus()
                    return;
                }
                if (!is_id(userid)) {
                    // 유저가 정규표현식에 맞지 않는 닉네임을 작성하였다면
                    $("#help-id").text("아이디의 형식을 확인해주세요. 알파벳 대소문자 및 숫자만 가능합니다!").removeClass("explanation-text").removeClass("is-safe").addClass("is-danger")
                    $("#user-id").focus()
                    return;
                }

                // 위 조건에 맞는 class부여, text 출력 후 기본 사용 class를 부여함
                $("#help-id").addClass("explanation-text")

                // 서버에 id값을 요청해서 유저가 적은 아이디가 이미 DB에 존재하는지 체크하기 위함
                $.ajax ({
                    type: "POST",
                    url: "/sign_up/check_dup",
                    data: {
                        userid_give: userid
                    },
                    success: function (response) {
                        if (response["exists"]) {
                            // 서버에서 exists가 true라면(같은 아이디가 존재한다면)
                            $("#help-id").text("이미 존재하는 아이디입니다.").removeClass("explanation-text").removeClass("is-safe").addClass("is-danger")
                            $("#user-id").focus()
                        } else {
                            // exists가 false라면(같은 아이디가 존재하지 않는다면)
                            $("#help-id").text("사용할 수 있는 아이디입니다.").removeClass("is-danger").addClass("is-safe")
                        }
                    }
                })
            }

            // 닉네임 중복확인 함수
            // 닉네임 입력 box아래의 '중복확인'버튼에 onclick함수로 기능함
            function check_nickname() {
                let usernick = $("#user-nick").val()
                console.log(usernick)
                if (usernick == "") {
                    // 유저가 닉네임을 적지 않았다면
                    $("#help-nick").text("닉네임을 입력해주세요.").removeClass("explanation-text").addClass("is-danger")
                    // 닉네임 box를 강조
                    $("#user-nick").focus()
                    return;
                }
                if (!is_nickname(usernick)) {
                    // 유저가 정규표현식에 맞지 않는 닉네임을 입력했다면
                    $("#help-nick").text("닉네임의 형식을 확인해주세요. 2~8자의 한글만 가능합니다.").removeClass("explanation-text").addClass("is-danger")
                    $("#user-nick").focus()
                    return;
                }

                // 위 조건에 맞는 class부여, 출력 후 다시 기본 class 부여
                $("#help-nick").addClass("explanation-text")
                $.ajax ({
                    type: "POST",
                    url: "/sign_up/check_dupnick",
                    data: {
                        usernick_give: usernick
                    },
                    success: function (response) {
                        if (response["exists"]) {
                            // 서버에서 exists가 true라면(같은 닉네임이 존재한다면)
                            $("#help-nick").text("이미 존재하는 닉네임입니다.").removeClass("explanation-text").addClass("is-danger")
                            $("#user-nick").focus()
                        } else {
                            // exists가 false라면(같은 닉네임이 존재하지 않는다면)
                            $("#help-nick").text("사용할 수 있는 닉네임입니다.").removeClass("is-danger").addClass("is-safe")
                        }
                    }
                })
            }
        </script>

        <style>
            {#헤더 스타일링#}
            .hero {
                width: 75%;
                margin: auto;
                text-align: center;
            }

            {#섹션 스타일링#}
            .section {
                width: 500px;
                margin: 50px auto;
                text-align: center;
            }

            {#ID, PW 설명 스타일링#}
            .explanation-text {
                font-size: 12px;
                color: lightslategrey;
            }

            {#도움메세지(id, pw, nickname 작성시)의 강조효과를 위한 디자인#}
            .is-danger {
                font-size: 12px;
                color: red;
            }

            .is-safe {
                font-size: 12px;
                color: blue;
            }

            {#box 스타일링#}
            .input {
                margin: 20px 0px 5px 0px;
            }

            {#회원가입button 스타일링#}
            .register-button {
                width: 300px;
                margin-top: 100px;
            }

            {#중복확인 button 스타일링#}
            .is-same-button {
                width: 100px;
                margin-bottom: 30px;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <section class="hero is-primary">
            <div class="hero-body">
                <p class="title">
                    회원가입
                </p>
            </div>
        </section>
        <section class="section">
            <div class="box">
                <div class="field">
                    <label class="label">아이디</label>
                    <div class="control">
                        <input class="input" type="text" id="user-id" placeholder="사용할 아이디를 입력하세요.">
                        <p class="explanation-text" id="help-id"> ID는 6~20자리 이상의 알파벳 대소문자 및 숫자만 사용할 수 있습니다.</p>
                    </div>
                </div>
                <button class="button is-primary is-rounded is-same-button" onclick="check_id()">중복확인</button>
                <div class="field">
                    <label class="label">비밀번호</label>
                    <div class="control">
                        <input class="input" type="password" id="user-pw" placeholder="사용할 비밀번호를 입력하세요.">
                        <p class="explanation-text" id="help-pw">비밀번호는 8~20자리의 알파벳 소문자와 숫자, 특수문자(!@#$%^&*)의 조합이어야 합니다.</p>
                    </div>
                </div>

                <div class="field">
                    <label class="label">비밀번호확인</label>
                    <div class="control">
                        <input class="input" type="password" id="user-pw2" placeholder="비밀번호를 한번 더 입력해주세요.">
                        <p class="explanation-text" id="help-pw2"></p>
                    </div>
                </div>

                <div class="field">
                    <label class="label">닉네임</label>
                    <div class="control">
                        <input class="input" type="text"  id="user-nick" placeholder="사용할 닉네임을 입력하세요.">
                        <p class="explanation-text" id="help-nick"> 닉네임은 한글만 2~8자까지 입력이 가능합니다.</p>
                        <button class="button is-primary is-rounded is-same-button" onclick="check_nickname()">중복확인</button>
                    </div>
                </div>

                <button class="button is-primary is-rounded register-button" onclick="register()">가입하기</button>
            </div>
        </section>
    </body>
</html>